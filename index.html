<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Norbin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{box-sizing:border-box;}
body{margin:0;background:#0b0b0b;color:#f1f1f1;font-family:monospace;}
.topbar{position:fixed;top:0;left:0;width:100%;height:50px;z-index:2000;display:flex;align-items:center;padding:0 15px;background:#0b0b0b;border-bottom:2px solid #333;}
.menu-btn{font-size:24px;cursor:pointer;user-select:none;margin-right:10px;}
.brand{font-size:20px;font-weight:bold;color:#ff0000;text-shadow:0 0 5px #ff0000,0 0 10px #ff0000,0 0 20px #ff0000;}
.top-menu{position:fixed;top:-300px;left:0;width:100%;background:#111;border-bottom:2px solid #222;padding:60px 15px 15px;transition:top 0.3s ease;z-index:1500;text-align:center;}
.top-menu.open{top:50px;}
.top-menu button{width:90%;margin:8px 0;padding:12px;background:#1a1a1a;color:#fff;border:1px solid #333;cursor:pointer;}
.top-menu button:hover{background:#222;}
.container{max-width:900px;margin:auto;padding:70px 20px 20px;}
.search{width:100%;padding:14px;font-size:16px;background:#111;color:#fff;border:2px solid #333;outline:none;}
.section{margin-top:25px;}
.section h2{border-bottom:1px solid #222;}
.paste{padding:12px;background:#111;border:1px solid #222;margin-bottom:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.paste:hover{background:#151515;}
.hidden{display:none;}
.paste-box{background:#111;border:2px solid #222;padding:15px;max-height:65vh;overflow-y:auto;white-space:pre-wrap;}
.input,textarea{width:100%;background:#111;color:#fff;border:2px solid #333;padding:12px;margin-bottom:10px;}
textarea{min-height:200px;resize:vertical;}
.form-buttons{display:flex;gap:10px;}
.form-buttons button{flex:1;padding:12px;border:none;cursor:pointer;}
.publish{background:#2a7;}
.clear{background:#922;}
.user-tag{font-weight:bold;margin-left:5px;}
.owner-tag{color:red;text-shadow:0 0 5px red,0 0 10px red,0 0 20px red;}
.admin-tag{color:darkblue;text-shadow:0 0 5px darkblue,0 0 10px darkblue,0 0 20px darkblue;}
.follow-btn{padding:5px 10px;background:#2a7;border:none;color:#fff;cursor:pointer;}
.admin-btn{padding:4px 8px;background:#922;border:none;color:#fff;margin-left:5px;}
.pin-btn{padding:4px 8px;background:#2a7;border:none;color:#fff;margin-left:5px;}
.profile-banner{width:100%;height:120px;object-fit:cover;margin-bottom:10px;border:1px solid #333;}
.profile-photo{width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid #2a7;margin-bottom:10px;}
</style>
<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="topbar">
  <div class="menu-btn" onclick="toggleMenu()">â˜°</div>
  <div class="brand">Norbin</div>
</div>

<div class="top-menu" id="menu">
  <button onclick="goHome()">Home</button>
  <button onclick="openPaste()">Create Paste</button>
  <button id="loginBtn" onclick="openLogin()">Login</button>
  <button id="signupBtn" onclick="openSignup()">Sign up</button>
  <button id="accountBtn" class="hidden" onclick="openAccount()">My Account</button>
  <button id="roleCodeBtn" class="hidden" onclick="openRoleCode()">Role Code</button>
  <button id="adminPanelBtn" class="hidden" onclick="openAdminPanel()">Admin Panel</button>
</div>

<div class="container">
<div id="home">
  <input class="search" placeholder="Search pastes..." oninput="search(this.value)">
  <div class="section"><h2>Pinned Pastes</h2><div id="pinned"></div></div>
  <div class="section"><h2>Recent Pastes</h2><div id="recent"></div></div>
</div>

<div id="create" class="hidden">
  <input class="input" id="pasteTitle" placeholder="Paste title">
  <textarea id="pasteText" placeholder="Paste content"></textarea>
  <div class="form-buttons">
    <button class="publish" onclick="publishPaste()">Publish</button>
    <button class="clear" onclick="clearPaste()">Clear</button>
  </div>
</div>

<div id="login" class="hidden">
  <h2>Login</h2>
  <input class="input" id="loginUser" placeholder="Email">
  <input class="input" id="loginPass" type="password" placeholder="Password">
  <div class="form-buttons">
    <button class="publish" onclick="loginUserFunc()">Login</button>
    <button class="clear" onclick="goHome()">Cancel</button>
  </div>
</div>

<div id="signup" class="hidden">
  <h2>Sign Up</h2>
  <input class="input" id="signupUser" placeholder="Email">
  <input class="input" id="signupPass" type="password" placeholder="Password">
  <div class="form-buttons">
    <button class="publish" onclick="signupUserFunc()">Sign up</button>
    <button class="clear" onclick="goHome()">Cancel</button>
  </div>
</div>

<div id="account" class="hidden">
  <h2>Account</h2>
  <img id="profileBanner" class="profile-banner" src="" alt="Banner">
  <img id="profilePhoto" class="profile-photo" src="" alt="Profile Photo">
  <p id="accName"></p>
  <div class="form-buttons">
    <button class="publish" onclick="updateUsernamePrompt()">Update Username</button>
    <button class="publish" onclick="updateProfilePhoto()">Update Photo</button>
    <button class="publish" onclick="updateBanner()">Update Banner</button>
  </div>
  <div id="userPastes"></div>
  <button class="clear" onclick="logout()">Log out</button>
</div>

<div id="adminPanel" class="hidden">
  <h2>Admin Panel</h2>
  <button onclick="togglePermissions()">Permissions</button>
  <div id="permissionsPanel" class="hidden">
    <h3>Users</h3>
    <div id="userList"></div>
    <h3>All Pastes</h3>
    <div id="pasteList"></div>
  </div>
</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBN29E6HxcBEAum3BU2ntbXWUfe6my9oy8",
  authDomain: "n0rb1n.firebaseapp.com",
  projectId: "n0rb1n",
  storageBucket: "n0rb1n.appspot.com",
  messagingSenderId: "269496774941",
  appId: "1:269496774941:web:74d9e873abbe707bdb31f4"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser=null;
let pastes=[];

const loginBtn=document.getElementById("loginBtn");
const signupBtn=document.getElementById("signupBtn");
const accountBtn=document.getElementById("accountBtn");
const roleCodeBtn=document.getElementById("roleCodeBtn");
const adminPanelBtn=document.getElementById("adminPanelBtn");
const pinned=document.getElementById("pinned");
const recent=document.getElementById("recent");

// MENU
function toggleMenu(){document.getElementById("menu").classList.toggle("open");}
function hideAll(){document.querySelectorAll(".container>div").forEach(d=>d.classList.add("hidden"));}
function goHome(){hideAll();document.getElementById("home").classList.remove("hidden");}
function openPaste(){hideAll();document.getElementById("create").classList.remove("hidden");}
function openLogin(){hideAll();document.getElementById("login").classList.remove("hidden");}
function openSignup(){hideAll();document.getElementById("signup").classList.remove("hidden");}
function openAccount(){hideAll();document.getElementById("account").classList.remove("hidden");loadUserAccount(currentUser);}
function openAdminPanel(){hideAll();document.getElementById("adminPanel").classList.remove("hidden");loadAdminPanel();}

// AUTH FUNCTIONS
function signupUserFunc(){
  const email=document.getElementById("signupUser").value.trim();
  const pass=document.getElementById("signupPass").value.trim();
  if(!email||!pass)return alert("Fill email & password");
  auth.createUserWithEmailAndPassword(email,pass).then(()=>{
    db.collection("users").doc(email).set({
      followers:[],
      role:null,
      username:email.split("@")[0],
      photoURL:"",
      bannerURL:""
    });
    currentUser=email; updateAuth(); goHome();
  }).catch(e=>alert(e.message));
}

function loginUserFunc(){
  const email=document.getElementById("loginUser").value.trim();
  const pass=document.getElementById("loginPass").value.trim();
  if(!email||!pass)return alert("Fill email & password");
  auth.signInWithEmailAndPassword(email,pass).then(()=>{currentUser=email;updateAuth();goHome();}).catch(e=>alert(e.message));
}

function logout(){auth.signOut();currentUser=null;updateAuth();goHome();}
function updateAuth(){
  loginBtn.classList.toggle("hidden",!!currentUser);
  signupBtn.classList.toggle("hidden",!!currentUser);
  accountBtn.classList.toggle("hidden",!currentUser);
  roleCodeBtn.classList.toggle("hidden",!currentUser);
  checkAdminRole();
}
function checkAdminRole(){
  if(!currentUser){adminPanelBtn.classList.add("hidden");return;}
  db.collection("users").doc(currentUser).get().then(doc=>{
    const role=doc.data()?.role;
    adminPanelBtn.classList.toggle("hidden",!(role==="admin"||role==="owner"));
  });
}

// LIVE PASTE FETCH
db.collection("pastes").orderBy("time","desc").onSnapshot(snap=>{
  pastes=snap.docs.map(d=>({id:d.id,...d.data()}));
  renderPastes();
});

function renderPastes(){
  pinned.innerHTML=""; recent.innerHTML="";
  pastes.forEach(p=>{
    const div=document.createElement("div"); div.className="paste";
    div.textContent=p.title + " by " + (p.username||p.author);
    div.onclick=()=>alert(p.text);
    if(p.pinned) pinned.appendChild(div); else recent.appendChild(div);
  });
}

function publishPaste(){
  const title=document.getElementById("pasteTitle").value.trim();
  const text=document.getElementById("pasteText").value.trim();
  if(!currentUser)return alert("Login first");
  if(!title||!text)return alert("Fill title & content");
  db.collection("users").doc(currentUser).get().then(doc=>{
    const username=doc.data()?.username || currentUser;
    db.collection("pastes").add({title,text,author:currentUser,username,time:Date.now(),pinned:false});
  });
  document.getElementById("pasteTitle").value="";
  document.getElementById("pasteText").value="";
  goHome();
}

auth.onAuthStateChanged(u=>{currentUser=u?u.email:null;updateAuth();goHome();});
</script>

</body>
</html>
